version: "3.8"

services:

  db:
    image: postgres:13.3-alpine
    container_name: remora-db
    shm_size: 2Gb
    command:
      - 'postgres'
      - '-c'
      - 'max_connections=512'
      - '-c'
      - 'shared_buffers=2GB'
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: crawler
      POSTGRES_DB: page_crawls
    restart: unless-stopped
    ports:
      - "55432:5432"
    volumes:
      - ./db/postgres:/docker-entrypoint-initdb.d:ro
      - ./data/postgres:/var/lib/postgresql/data/

  mq:
    image: rabbitmq:3-management-alpine
    container_name: remora-msgq
    # environment:
    #  RABBITMQ_VM_MEMORY_HIGH_WATERMARK: 0.65
    ports:
      - "5672:5672"
      - "15672:15672"
    restart: unless-stopped

  visited:
    image: redis:6.2.4-alpine
    container_name: remora-visited-set
    ports:
      - 6379:6379
    restart: unless-stopped

  crawler:
    image: remora:latest
    build:
      dockerfile: ./Dockerfile
      context: .
      target: remora
    container_name: remora-crawler
    network_mode: host
    command: ["spider", "en.wikipedia.org"]
    # Volume is overridden in prod
    volumes:
      - ./config/config.yml:/var/local/remora/config.yml:ro

  api:
    image: remora-api:latest
    build:
      dockerfile: ./Dockerfile
      context: .
      target: api
    command: ["-p", "8080"]
    container_name: remora-api
    network_mode: host
    # Volume is overridden in prod
    volumes:
      - ./config/config.yml:/var/local/remora/config.yml:ro
    ports:
      - "8080:8080"
    restart: unless-stopped

  search:
    image: solr:8.11.0
    container_name: remora-search
    restart: unless-stopped
    ports:
      - "8983:8983"

  # dummy:
  #   # image: nothing:latest
  #   # build:
  #     # dockerfile: docker/Dockerfile.nothing
  #     # context: .
  #   image: alpine:latest
  #   command: ["tail", "-f", "/dev/null"]
  #   volumes:
  #     - remora-config:/var/local/remora
  #     - ./config/config.yml:/var/local/remora/config.yml

volumes:
  remora-config: {}
